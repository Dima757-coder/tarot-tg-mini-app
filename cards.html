<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>–¢–∞—Ä–æ –†–∞—Å–∫–ª–∞–¥</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f5f5f5;
      text-align: center;
      padding: 20px;
      margin: 0;
    }
    .card-container {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 20px;
      margin-top: 30px;
    }
    .card {
      width: 100px;
      height: 160px;
      perspective: 1000px;
      cursor: pointer;
    }
    .card-inner {
      position: relative;
      width: 100%;
      height: 100%;
      transition: transform 0.6s;
      transform-style: preserve-3d;
    }
    .card.flipped .card-inner {
      transform: rotateY(180deg);
    }
    .card-front,
    .card-back {
      position: absolute;
      width: 100%;
      height: 100%;
      backface-visibility: hidden;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    .card-front {
      background-image: url('https://iili.io/38S5Ab9.png');
      background-size: cover;
    }
    .card-back {
      transform: rotateY(180deg);
      background-color: white;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 10px;
    }
    .card-back img {
      width: 100%;
      height: auto;
      max-height: 75%;
      border-radius: 10px;
    }
    .btn {
      margin: 20px 10px;
      padding: 12px 20px;
      font-size: 16px;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    .btn:hover {
      background-color: #45a049;
    }
    .reset-btn {
      background-color: #f44336;
    }
    .reset-btn:hover {
      background-color: #d32f2f;
    }
    @media (max-width: 600px) {
      .card-container {
        grid-template-columns: repeat(2, 1fr);
      }
      .card {
        width: 80px;
        height: 128px;
      }
    }
  </style>
</head>
<body>
  <h1>–í—ã–±–µ—Ä–∏—Ç–µ 3 –∫–∞—Ä—Ç—ã</h1>
  <div id="card-container" class="card-container"></div>

  <script>
    // –ú–∞—Å—Å–∏–≤ –∫–∞—Ä—Ç –¢–∞—Ä–æ (22 —Å—Ç–∞—Ä—à–∏—Ö –∞—Ä–∫–∞–Ω–∞, –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã –¥—É–±–ª–∏—Ä—É—é—â–∏–µ—Å—è URL)
    const tarotCards = [
      { name: "–ú–∞–≥", image_url_up: "https://iili.io/38S5Ab9.png", image_url_down: "https://iili.io/38SU0rb.png" },
      { name: "–ñ—Ä–∏—Ü–∞", image_url_up: "https://iili.io/38S5Vb1.png", image_url_down: "https://iili.io/38SUGYx.png" },
      { name: "–ò–º–ø–µ—Ä–∞—Ç—Ä–∏—Ü–∞", image_url_up: "https://iili.io/38SUTQv.png", image_url_down: "https://iili.io/38SUzUN.png" },
      { name: "–ò–º–ø–µ—Ä–∞—Ç–æ—Ä", image_url_up: "https://iili.io/38SUWcI.png", image_url_down: "https://iili.io/38SUjXG.png" },
      { name: "–°–≤—è—â–µ–Ω–Ω–∏–∫", image_url_up: "https://iili.io/38SUqJt.png", image_url_down: "https://iili.io/38SUaLr.png" },
      { name: "–í–ª—é–±–ª—ë–Ω–Ω—ã–µ", image_url_up: "https://iili.io/38SUeKg.png", image_url_down: "https://iili.io/38SUZnP.png" },
      { name: "–ö–æ–ª–µ—Å–Ω–∏—Ü–∞", image_url_up: "https://iili.io/38SUHsF.png", image_url_down: "https://iili.io/38SUXyR.png" },
      { name: "–°–∏–ª–∞", image_url_up: "https://iili.io/38SUwEo.png", image_url_down: "https://iili.io/38SUlVn.png" },
      { name: "–û—Ç—à–µ–ª—å–Ω–∏–∫", image_url_up: "https://iili.io/38SUKkS.png", image_url_down: "https://iili.io/38SUgPh.png" },
      { name: "–ö–æ–ª–µ—Å–æ –§–æ—Ä—Ç—É–Ω—ã", image_url_up: "https://iili.io/38SUmdA.png", image_url_down: "https://iili.io/38SUtBj.png" },
      { name: "–°–ø—Ä–∞–≤–µ–¥–ª–∏–≤–æ—Å—Ç—å", image_url_up: "https://iili.io/38SUOQb.png", image_url_down: "https://iili.io/38SUvNp.png" },
      { name: "–ü–æ–≤–µ—à–µ–Ω–Ω—ã–π", image_url_up: "https://iili.io/38SU9uF.png", image_url_down: "https://iili.io/38SUFP2.png" },
      { name: "–°–º–µ—Ä—Ç—å", image_url_up: "https://iili.io/38SUQmS.png", image_url_down: "https://iili.io/38SURVx.png" },
      { name: "–£–º–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å", image_url_up: "https://iili.io/38SUJsh.png", image_url_down: "https://iili.io/38SUPEM.png" },
      { name: "–î—å—è–≤–æ–ª", image_url_up: "https://iili.io/38SUY1u.png", image_url_down: "https://iili.io/38SUk7I.png" },
      { name: "–ë–∞—à–Ω—è", image_url_up: "https://iili.io/38SUnXb.png", image_url_down: "https://iili.io/38SU3tF.png" },
      { name: "–ó–≤–µ–∑–¥–∞", image_url_up: "https://iili.io/38SUcRS.png", image_url_down: "https://iili.io/38SUBUh.png" },
      { name: "–õ—É–Ω–∞", image_url_up: "https://iili.io/38SUI4A.png", image_url_down: "https://iili.io/38SU2Fj.png" },
      { name: "–°–æ–ª–Ω—Ü–µ", image_url_up: "https://iili.io/38SU4Np.png", image_url_down: "https://iili.io/38SU8Hu.png" },
      { name: "–°—É–¥", image_url_up: "https://iili.io/38SUMf2.png", image_url_down: "https://iili.io/38SUxCS.png" },
      { name: "–ú–∏—Ä", image_url_up: "https://iili.io/38SU6Rh.png", image_url_down: "https://iili.io/38SUDnm.png" },
      { name: "–®—É—Ç", image_url_up: "https://iili.io/38SUrbB.png", image_url_down: "https://iili.io/38SU1oF.png" }
    ];

    document.addEventListener("DOMContentLoaded", () => {
      const container = document.getElementById("card-container");
      let tg;
      if (window.Telegram && window.Telegram.WebApp) {
        tg = window.Telegram.WebApp;
        tg.ready();
      } else {
        alert("–≠—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –æ—Ç–∫—Ä—ã—Ç–æ –≤ Telegram.");
        return;
      }

      let selectedCards = [];
      const totalCardsToShow = 6;
      let usedCards = [];

      const urlParams = new URLSearchParams(window.location.search);
      const question = urlParams.get('question') || "–ö–∞–∫ –º–Ω–µ –∏–∑–º–µ–Ω–∏—Ç—å –∂–∏–∑–Ω—å?";

      function createCards() {
        container.innerHTML = '';
        for (let i = 0; i < totalCardsToShow; i++) {
          const card = document.createElement("div");
          card.classList.add("card");
          card.dataset.id = i;
          card.innerHTML = `
            <div class="card-inner">
              <div class="card-front"></div>
              <div class="card-back"></div>
            </div>
          `;
          card.addEventListener("click", () => selectCard(card));
          container.appendChild(card);
        }
      }

      function selectCard(card) {
        if (selectedCards.includes(card)) return;

        if (selectedCards.length >= 3) {
          alert("–ú–æ–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å —Ç–æ–ª—å–∫–æ 3 –∫–∞—Ä—Ç—ã");
          return;
        }

        let availableCards = tarotCards.filter(c => !usedCards.includes(c.name));
        if (availableCards.length === 0) {
          alert("–í—Å–µ –∫–∞—Ä—Ç—ã —É–∂–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω—ã. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–∞—á–Ω–∏—Ç–µ –∑–∞–Ω–æ–≤–æ.");
          return;
        }

        let meaning = shuffleArray(availableCards)[0];
        usedCards.push(meaning.name);
        selectedCards.push(card);
        card.classList.add("selected");

        const isReversed = Math.random() < 0.5;
        const back = card.querySelector(".card-back");

        const img = document.createElement("img");
        img.src = isReversed ? meaning.image_url_down : meaning.image_url_up;
        img.alt = meaning.name;
        img.onerror = () => {
          console.error(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–ª—è –∫–∞—Ä—Ç—ã: ${meaning.name}`);
          img.src = "https://iili.io/38S5Ab9.png"; // –†–µ–∑–µ—Ä–≤–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
        };

        back.innerHTML = '';
        back.appendChild(img);
        back.appendChild(document.createElement("p")).textContent = meaning.name;
        back.appendChild(document.createElement("small")).textContent = isReversed ? '(–ü–µ—Ä–µ–≤–µ—Ä–Ω—É—Ç–∞—è)' : '(–ü—Ä—è–º–∞—è)';

        card.dataset.position = isReversed ? 'reversed' : 'upright';

        setTimeout(() => {
          card.classList.add("flipped");
        }, 100);

        if (selectedCards.length === 3) {
          showButtons();
        }
      }

      function showButtons() {
        const oldContinueBtn = document.getElementById("continue-btn");
        const oldResetBtn = document.getElementById("reset-btn");
        if (oldContinueBtn) oldContinueBtn.remove();
        if (oldResetBtn) oldResetBtn.remove();

        const continueBtn = document.createElement("button");
        continueBtn.textContent = "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å";
        continueBtn.id = "continue-btn";
        continueBtn.classList.add("btn");

        continueBtn.addEventListener("click", () => {
          const selectedCardsData = selectedCards.map((card) => {
            return {
              name: card.querySelector(".card-back p").textContent,
              position: card.dataset.position
            };
          });

          if (selectedCardsData.some(card => !card.name || !card.position)) {
            console.error("–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∫–∞—Ä—Ç:", selectedCardsData);
            alert("–û—à–∏–±–∫–∞: –¥–∞–Ω–Ω—ã–µ –∫–∞—Ä—Ç –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã.");
            return;
          }

          console.log("üì§ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º—ã–µ –¥–∞–Ω–Ω—ã–µ:", { cards: selectedCardsData, question });

          try {
            tg.sendData(JSON.stringify({ cards: selectedCardsData, question }));
            console.log("‚úÖ –î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –≤ Telegram Web App");
            setTimeout(() => {
              tg.close();
            }, 500);
          } catch (error) {
            console.error("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –¥–∞–Ω–Ω—ã—Ö:", error);
            alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –¥–∞–Ω–Ω—ã—Ö –≤ Telegram.");
          }
        });

        const resetBtn = document.createElement("button");
        resetBtn.textContent = "–ù–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ";
        resetBtn.id = "reset-btn";
        resetBtn.classList.add("btn", "reset-btn");

        resetBtn.addEventListener("click", () => {
          selectedCards = [];
          usedCards = [];
          container.querySelectorAll(".card").forEach(card => {
            card.removeEventListener("click", selectCard);
          });
          createCards();
          const oldContinueBtn = document.getElementById("continue-btn");
          const oldResetBtn = document.getElementById("reset-btn");
          if (oldContinueBtn) oldContinueBtn.remove();
          if (oldResetBtn) oldResetBtn.remove();
        });

        document.body.appendChild(continueBtn);
        document.body.appendChild(resetBtn);
      }

      function shuffleArray(array) {
        const newArray = [...array];
        for (let i = newArray.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
        }
        return newArray;
      }

      createCards();
    });
  </script>
</body>
</html>
